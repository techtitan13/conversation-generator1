<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Conversation Generator - Public Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
  <div id="root"></div>

  <script type="module">
    // âš ï¸ REPLACE THESE WITH YOUR CREDENTIALS
    const SUPABASE_URL = 'https://feohwmdogtwwseyaohdo.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_jlcqCVhEyIQNKgIBqox1_Q_1g5A6o8W';
    
    // âš ï¸ SET YOUR ADMIN PASSWORD HERE (change this!)
    const ADMIN_PASSWORD = 'admin123';
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let state = {
      conversations: [],
      newConvo: '',
      topic: '',
      generatedConvo: '',
      loading: false,
      activeTab: 'generate',
      isInitialized: false,
      totalConversations: 0,
      isAdmin: false,
      showAdminLogin: false,
      adminPassword: ''
    };

    function setState(updates) {
      state = { ...state, ...updates };
      render();
    }

    // Check if user is admin on load
    async function checkAdminStatus() {
      const token = localStorage.getItem('adminToken');
      if (!token) {
        setState({ isAdmin: false });
        return;
      }

      try {
        const { data, error } = await supabase
          .from('admin_sessions')
          .select('*')
          .eq('session_token', token)
          .gt('expires_at', new Date().toISOString())
          .single();

        if (error || !data) {
          localStorage.removeItem('adminToken');
          setState({ isAdmin: false });
        } else {
          setState({ isAdmin: true });
        }
      } catch (error) {
        localStorage.removeItem('adminToken');
        setState({ isAdmin: false });
      }
    }

    // Admin login
    async function adminLogin() {
      if (state.adminPassword === ADMIN_PASSWORD) {
        // Generate session token
        const token = 'admin_' + Math.random().toString(36).substring(2) + Date.now().toString(36);
        
        try {
          const { error } = await supabase
            .from('admin_sessions')
            .insert([{ 
              session_token: token,
              expires_at: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString()
            }]);

          if (error) throw error;

          localStorage.setItem('adminToken', token);
          setState({ isAdmin: true, showAdminLogin: false, adminPassword: '' });
          alert('âœ… Logged in as Admin!');
        } catch (error) {
          console.error('Login error:', error);
          alert('Login failed. Please try again.');
        }
      } else {
        alert('âŒ Incorrect password!');
        setState({ adminPassword: '' });
      }
    }

    // Admin logout
    function adminLogout() {
      localStorage.removeItem('adminToken');
      setState({ isAdmin: false, adminPassword: '' });
      alert('ğŸ‘‹ Logged out successfully!');
    }

    async function loadConversations() {
      try {
        const { data, error } = await supabase
          .from('conversations')
          .select('*')
          .order('added_at', { ascending: false });

        if (error) throw error;

        setState({ 
          conversations: data || [], 
          totalConversations: data?.length || 0,
          isInitialized: true 
        });
      } catch (error) {
        console.error('Error loading:', error);
        alert('Error loading conversations: ' + error.message);
        setState({ isInitialized: true });
      }
    }

    async function addConversation() {
      if (!state.newConvo.trim()) {
        alert('Please enter a conversation');
        return;
      }

      try {
        const { error } = await supabase
          .from('conversations')
          .insert([{ content: state.newConvo }]);

        if (error) throw error;

        alert('âœ… Conversation added successfully!');
        setState({ newConvo: '' });
        await loadConversations();
      } catch (error) {
        console.error('Error adding:', error);
        alert('Error adding conversation: ' + error.message);
      }
    }

    async function deleteConversation(id) {
      if (!state.isAdmin) {
        alert('âŒ Only admins can delete conversations!');
        return;
      }

      if (!confirm('Delete this conversation? This cannot be undone.')) return;

      try {
        const { error } = await supabase
          .from('conversations')
          .delete()
          .eq('id', id);

        if (error) throw error;

        await loadConversations();
        alert('âœ… Conversation deleted!');
      } catch (error) {
        console.error('Error deleting:', error);
        alert('Error deleting conversation: ' + error.message);
      }
    }

    async function generateConversation() {
      if (!state.topic.trim()) {
        alert('Please enter a topic/description for the conversation');
        return;
      }

      if (state.conversations.length === 0) {
        alert('Please add some sample conversations first. The AI needs examples to learn from!');
        return;
      }

      setState({ loading: true, generatedConvo: '' });

      try {
        const samples = state.conversations
          .sort(() => Math.random() - 0.5)
          .slice(0, Math.min(5, state.conversations.length))
          .map((c, idx) => `EXAMPLE ${idx + 1}:\n${c.content}`)
          .join('\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n');

        const prompt = `You are an expert conversation pattern replicator. Your job is to study example conversations and generate NEW conversations that EXACTLY match their style, format, and structure.

TASK: Generate a conversation about the following topic/description:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
${state.topic}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

REFERENCE EXAMPLES (Study these patterns CAREFULLY):
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
${samples}
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CRITICAL ANALYSIS - Before generating, identify:
1. EXACT format pattern (e.g., "Buyer:" vs "Customer:" vs other labels)
2. Typical conversation length (count the exchanges)
3. Greeting style (formal/informal)
4. Question types and depth
5. How details are discussed (features, price, condition)
6. Negotiation patterns (if any)
7. Closing style
8. Punctuation and spacing patterns

STRICT REQUIREMENTS - Your generated conversation MUST:
âœ“ Use IDENTICAL speaker labels as examples (Buyer:/Seller: or whatever format they use)
âœ“ Match the average length of examples (similar number of exchanges)
âœ“ Follow the EXACT same formatting (spacing, line breaks, punctuation)
âœ“ Use similar language style and tone (formal/casual/technical)
âœ“ Follow similar conversation flow structure
âœ“ Include similar types of questions and details
âœ“ Sound natural and realistic
âœ“ Be about the NEW topic provided above (not example topics)
âœ“ NOT copy any sentences from examples word-for-word

OUTPUT RULES:
âš  Output ONLY the conversation itself
âš  NO introductions like "Here's the conversation" or explanations
âš  NO markdown formatting or code blocks
âš  Start IMMEDIATELY with the first line of dialogue
âš  Use exact same line formatting as examples

BEGIN GENERATING NOW:`;

        const response = await fetch('/api/generate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ prompt }),
        });

        const data = await response.json();

        if (data.text) {
          let cleanedText = data.text.trim();
          
          cleanedText = cleanedText
            .replace(/^(Here's the conversation|Here is the conversation|Here's|Here is|Generated conversation:?|Let me (create|generate)|I'll (create|generate)|Sure,? here'?s?|Okay,? here'?s?)/i, '')
            .replace(/^[:\-\s]+/, '')
            .trim();
          
          cleanedText = cleanedText.replace(/^```[\w]*\n?/gm, '').replace(/\n?```$/gm, '');
          
          const hasDialogueFormat = /^(Buyer|Seller|Customer|Agent|User|Person|Client|Representative|Support|Sales|Student|Teacher|Applicant|Interviewer|Patient|Doctor|Host|Guest):/im.test(cleanedText);
          
          if (!hasDialogueFormat) {
            console.warn('Generated text might not match expected format');
            const looksLikeConversation = cleanedText.includes(':') && cleanedText.split('\n').length > 3;
            
            if (!looksLikeConversation) {
              alert('âš ï¸ The AI response doesn\'t look like a proper conversation. Try generating again.');
            }
          }
          
          const lineCount = cleanedText.split('\n').filter(line => line.trim().length > 0).length;
          if (lineCount < 4) {
            alert('âš ï¸ Generated conversation seems too short. Try again or add more detailed examples.');
          }
          
          setState({ generatedConvo: cleanedText, loading: false });
        } else {
          throw new Error(data.error || 'No response from API');
        }
      } catch (error) {
        console.error('Generation error:', error);
        alert('Failed to generate conversation: ' + error.message);
        setState({ loading: false });
      }
    }

    function exportData() {
      const dataStr = JSON.stringify(state.conversations, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'conversations-backup.json';
      link.click();
    }

    function render() {
      const root = document.getElementById('root');
      
      if (!state.isInitialized) {
        root.innerHTML = `
          <div class="min-h-screen flex items-center justify-center">
            <div class="text-lg text-gray-600">Loading...</div>
          </div>
        `;
        return;
      }

      root.innerHTML = `
        <div class="min-h-screen p-6">
          <div class="max-w-7xl mx-auto">
            
            <!-- Header -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
              <div class="flex justify-between items-start">
                <div>
                  <h1 class="text-3xl font-bold text-gray-800 mb-2">
                    ğŸŒ Public Conversation Generator
                  </h1>
                  <p class="text-gray-600">
                    AI-powered conversation generator with community database
                  </p>
                  <div class="mt-4 flex gap-4 text-sm">
                    <div class="flex items-center gap-2">
                      <span class="font-semibold text-2xl text-blue-600">${state.totalConversations}</span>
                      <span class="text-gray-600">conversations in database</span>
                    </div>
                  </div>
                </div>
                
                <!-- Admin Section -->
                <div class="flex flex-col items-end gap-2">
                  ${state.isAdmin ? `
                    <div class="flex items-center gap-2 bg-green-100 px-4 py-2 rounded-lg border-2 border-green-300">
                      <span class="text-2xl">ğŸ‘‘</span>
                      <span class="font-bold text-green-800">Admin Mode</span>
                    </div>
                    <button
                      onclick="window.adminLogout()"
                      class="text-sm text-red-600 hover:text-red-700 font-medium"
                    >
                      ğŸšª Logout
                    </button>
                  ` : `
                    <button
                      onclick="window.toggleAdminLogin()"
                      class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-gray-700 font-medium transition-all"
                    >
                      ğŸ” Admin Login
                    </button>
                  `}
                </div>
              </div>

              <!-- Admin Login Modal -->
              ${state.showAdminLogin && !state.isAdmin ? `
                <div class="mt-4 p-4 bg-blue-50 border-2 border-blue-300 rounded-lg">
                  <h3 class="font-bold text-gray-800 mb-3">ğŸ” Admin Login</h3>
                  <div class="flex gap-2">
                    <input
                      type="password"
                      id="adminPasswordInput"
                      placeholder="Enter admin password"
                      class="flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      value="${state.adminPassword}"
                    />
                    <button
                      onclick="window.adminLogin()"
                      class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium"
                    >
                      Login
                    </button>
                    <button
                      onclick="window.toggleAdminLogin()"
                      class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400"
                    >
                      Cancel
                    </button>
                  </div>
                </div>
              ` : ''}
            </div>

            <!-- Tabs -->
            <div class="bg-white rounded-lg shadow-lg mb-6">
              <div class="flex border-b">
                <button onclick="window.setTab('generate')" class="px-6 py-3 font-medium ${state.activeTab === 'generate' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600 hover:text-gray-800'}">
                  âœ¨ Generate
                </button>
                <button onclick="window.setTab('manage')" class="px-6 py-3 font-medium ${state.activeTab === 'manage' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600 hover:text-gray-800'}">
                  ğŸ’¬ Manage Conversations
                </button>
              </div>

              <!-- Generate Tab -->
              ${state.activeTab === 'generate' ? `
                <div class="p-6">
                  <div class="mb-6">
                    <label class="block text-base font-semibold text-gray-800 mb-3">
                      ğŸ“ Describe Your Conversation Topic/Requirements
                    </label>
                    <p class="text-sm text-gray-600 mb-3">
                      The AI will analyze ${state.conversations.length > 0 ? state.conversations.length : 'your'} sample conversation${state.conversations.length !== 1 ? 's' : ''} and generate a NEW conversation matching their exact style and format!
                    </p>
                    <textarea
                      id="topicInput"
                      placeholder="Example: A conversation about selling a used iPhone 15 Pro Max 256GB in excellent condition with original box and accessories. The buyer is asking about battery health and any scratches. Price is negotiable around $900."
                      rows="6"
                      class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-y text-gray-800"
                    >${state.topic}</textarea>
                    <p class="text-xs text-gray-500 mt-2">
                      ğŸ’¡ <strong>Pro Tip:</strong> Be specific! Include product details, conditions, price range, and any special requirements for best results.
                    </p>
                  </div>

                  <button
                    onclick="window.generateConvo()"
                    ${state.loading || state.conversations.length === 0 ? 'disabled' : ''}
                    class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-4 rounded-lg font-semibold text-lg hover:from-blue-700 hover:to-indigo-700 disabled:from-gray-400 disabled:to-gray-400 disabled:cursor-not-allowed shadow-lg hover:shadow-xl transition-all duration-200"
                  >
                    ${state.loading ? 'â³ AI Analyzing Patterns & Generating...' : 'âœ¨ Generate Pattern-Matched Conversation'}
                  </button>

                  ${state.conversations.length === 0 ? `
                    <div class="mt-4 p-4 bg-orange-50 border-l-4 border-orange-500 rounded-lg">
                      <div class="flex items-start">
                        <span class="text-2xl mr-3">âš ï¸</span>
                        <div>
                          <p class="font-semibold text-orange-800">No Sample Conversations in Database</p>
                          <p class="text-sm text-orange-700 mt-1">
                            The AI needs sample conversations to learn patterns from! Add at least 3-5 conversations in the "Manage Conversations" tab.
                          </p>
                        </div>
                      </div>
                    </div>
                  ` : state.conversations.length < 3 ? `
                    <div class="mt-4 p-4 bg-yellow-50 border-l-4 border-yellow-500 rounded-lg">
                      <div class="flex items-start">
                        <span class="text-2xl mr-3">ğŸ’¡</span>
                        <div>
                          <p class="font-semibold text-yellow-800">Tip: Add More Examples</p>
                          <p class="text-sm text-yellow-700 mt-1">
                            You have ${state.conversations.length} conversation${state.conversations.length !== 1 ? 's' : ''}. Adding 3-5+ examples will help the AI learn better patterns!
                          </p>
                        </div>
                      </div>
                    </div>
                  ` : ''}

                  ${state.generatedConvo ? `
                    <div class="mt-6 bg-gradient-to-br from-green-50 to-blue-50 rounded-lg p-6 border-2 border-green-200">
                      <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                          <span class="text-2xl">âœ…</span>
                          Generated Conversation
                        </h3>
                        <button
                          onclick="navigator.clipboard.writeText(\`${state.generatedConvo.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`); alert('âœ… Copied to clipboard!')"
                          class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium flex items-center gap-2 shadow-md hover:shadow-lg transition-all"
                        >
                          ğŸ“‹ Copy
                        </button>
                      </div>
                      <div class="bg-white p-5 rounded-lg border border-gray-200 whitespace-pre-wrap max-h-[500px] overflow-y-auto text-gray-800 leading-relaxed shadow-inner font-mono text-sm">
${state.generatedConvo}
                      </div>
                      <div class="mt-3 text-xs text-gray-600 bg-blue-50 p-3 rounded">
                        â„¹ï¸ This conversation was generated by AI based on ${Math.min(5, state.conversations.length)} sample conversation${Math.min(5, state.conversations.length) !== 1 ? 's' : ''} from the database.
                      </div>
                    </div>
                  ` : ''}
                </div>
              ` : ''}

              <!-- Manage Tab -->
              ${state.activeTab === 'manage' ? `
                <div class="p-6">
                  <div class="mb-6">
                    <div class="flex justify-between items-center mb-3">
                      <label class="block text-base font-semibold text-gray-800">
                        â• Add New Conversation to Database
                      </label>
                      ${state.conversations.length > 0 ? `
                        <button
                          onclick="window.exportData()"
                          class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium flex items-center gap-2 shadow-md hover:shadow-lg transition-all"
                        >
                          ğŸ“¥ Export All (${state.conversations.length})
                        </button>
                      ` : ''}
                    </div>
                    <p class="text-sm text-gray-600 mb-3">
                      ${state.isAdmin ? 'ğŸ‘‘ <strong>Admin:</strong> You can add and delete conversations.' : 'ğŸ‘¤ <strong>Visitor:</strong> You can add conversations. Only admins can delete.'}
                    </p>
                    <textarea
                      id="newConvoInput"
                      placeholder="Paste a conversation here...

Example format:
Buyer: Hi, is the iPhone still available?
Seller: Yes! It's in excellent condition with 95% battery health.
Buyer: Can you send more photos of the screen?
Seller: Sure, I'll send them right now. No scratches at all!
..."
                      rows="8"
                      class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 resize-y font-mono text-sm"
                    >${state.newConvo}</textarea>
                    <button
                      onclick="window.addConvo()"
                      class="mt-3 bg-gradient-to-r from-green-600 to-emerald-600 text-white px-6 py-3 rounded-lg font-semibold hover:from-green-700 hover:to-emerald-700 flex items-center gap-2 shadow-lg hover:shadow-xl transition-all"
                    >
                      â• Add to Database
                    </button>
                  </div>

                  <div>
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                      <span class="text-2xl">ğŸ’¬</span>
                      Community Database (${state.totalConversations})
                    </h3>
                    
                    ${state.conversations.length === 0 ? `
                      <div class="text-center py-16 bg-gradient-to-br from-gray-50 to-blue-50 rounded-lg border-2 border-dashed border-gray-300">
                        <div class="text-6xl mb-4">ğŸ“­</div>
                        <p class="text-xl font-semibold text-gray-700">No conversations yet</p>
                        <p class="text-gray-600 mt-2">
                          Add your first conversation to start building the AI training database!
                        </p>
                      </div>
                    ` : `
                      <div class="space-y-4 max-h-[600px] overflow-y-auto">
                        ${state.conversations.map(convo => `
                          <div class="bg-gradient-to-br from-white to-gray-50 p-5 rounded-lg border-2 border-gray-200 hover:border-blue-300 hover:shadow-lg transition-all">
                            <div class="flex justify-between items-start mb-3">
                              <span class="text-xs font-medium text-gray-500 bg-gray-100 px-3 py-1 rounded-full">
                                ğŸ“… ${new Date(convo.added_at).toLocaleString()}
                              </span>
                              ${state.isAdmin ? `
                                <button
                                  onclick="window.deleteConvo(${convo.id})"
                                  class="text-red-600 hover:text-red-700 hover:bg-red-50 px-3 py-1 rounded-lg font-medium transition-all flex items-center gap-1"
                                >
                                  ğŸ—‘ï¸ Delete
                                </button>
                              ` : `
                                <span class="text-xs text-gray-400 px-3 py-1">ğŸ”’ Protected</span>
                              `}
                            </div>
                            <div class="text-sm text-gray-700 whitespace-pre-wrap leading-relaxed line-clamp-6 font-mono">
${convo.content}
                            </div>
                          </div>
                        `).join('')}
                      </div>
                    `}
                  </div>
                </div>
              ` : ''}
            </div>

            <!-- Instructions -->
            <div class="bg-gradient-to-br from-white to-blue-50 rounded-lg shadow-lg p-6 border-2 border-blue-100">
              <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <span class="text-2xl">ğŸ“–</span>
                How It Works
              </h3>
              <div class="space-y-3 text-gray-700">
                <div class="flex items-start gap-3">
                  <span class="text-2xl font-bold text-blue-600">1.</span>
                  <div>
                    <strong>Train the AI:</strong> Add 3-5+ real conversations. The AI analyzes their format, style, length, and patterns.
                  </div>
                </div>
                <div class="flex items-start gap-3">
                  <span class="text-2xl font-bold text-blue-600">2.</span>
                  <div>
                    <strong>Describe Topic:</strong> Write what you want the conversation to be about. Be detailed for best results!
                  </div>
                </div>
                <div class="flex items-start gap-3">
                  <span class="text-2xl font-bold text-blue-600">3.</span>
                  <div>
                    <strong>AI Generates:</strong> The AI creates a NEW conversation that matches your examples' style but with your new topic.
                  </div>
                </div>
              </div>
              
              <div class="mt-5 p-4 bg-blue-100 rounded-lg border-2 border-blue-300">
                <p class="text-sm text-gray-800">
                  <strong>ğŸ‘¤ User Roles:</strong> All visitors can add conversations to help grow the database. Only admins can delete conversations to maintain quality.
                </p>
              </div>
            </div>
          </div>
        </div>
      `;

      // Event listeners
      const topicInput = document.getElementById('topicInput');
      if (topicInput) {
        topicInput.addEventListener('input', (e) => {
          state.topic = e.target.value;
        });
      }

      const newConvoInput = document.getElementById('newConvoInput');
      if (newConvoInput) {
        newConvoInput.addEventListener('input', (e) => {
          state.newConvo = e.target.value;
        });
      }

      const adminPasswordInput = document.getElementById('adminPasswordInput');
      if (adminPasswordInput) {
        adminPasswordInput.addEventListener('input', (e) => {
          state.adminPassword = e.target.value;
        });
        adminPasswordInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            adminLogin();
          }
        });
      }
    }

    // Global functions
    window.setTab = (tab) => setState({ activeTab: tab });
    window.addConvo = addConversation;
    window.deleteConvo = deleteConversation;
    window.generateConvo = generateConversation;
    window.exportData = exportData;
    window.adminLogin = adminLogin;
    window.adminLogout = adminLogout;
    window.toggleAdminLogin = () => setState({ showAdminLogin: !state.showAdminLogin, adminPassword: '' });

    // Initialize
    async function init() {
      await checkAdminStatus();
      await loadConversations();
    }
    
    init();
  </script>
</body>
</html>
